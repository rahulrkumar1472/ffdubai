import fs from "node:fs/promises";
import path from "node:path";

const IMAGE_EXTENSIONS = new Set([".jpg", ".jpeg", ".png", ".webp"]);

const projectRoot = process.cwd();
const sources = [
  {
    label: "stock",
    absoluteDir: path.join(projectRoot, "public", "images", "stock"),
    publicPrefix: "/images/stock"
  },
  {
    label: "before-after",
    absoluteDir: path.join(projectRoot, "public", "images", "before-after"),
    publicPrefix: "/images/before-after"
  }
];

function toWebPath(value) {
  return value.split(path.sep).join("/");
}

async function walkImageFiles(rootDir, currentDir = "") {
  const absoluteCurrentDir = path.join(rootDir, currentDir);
  let entries = [];

  try {
    entries = await fs.readdir(absoluteCurrentDir, {withFileTypes: true});
  } catch {
    return [];
  }

  const files = [];

  for (const entry of entries) {
    const relativePath = path.join(currentDir, entry.name);

    if (entry.isDirectory()) {
      files.push(...(await walkImageFiles(rootDir, relativePath)));
      continue;
    }

    if (!entry.isFile()) {
      continue;
    }

    const extension = path.extname(entry.name).toLowerCase();

    if (!IMAGE_EXTENSIONS.has(extension)) {
      continue;
    }

    files.push(toWebPath(relativePath));
  }

  return files;
}

async function buildSourceManifest(source) {
  const images = await walkImageFiles(source.absoluteDir);
  const mapped = images.sort((a, b) => a.localeCompare(b)).map((value) => `${source.publicPrefix}/${value}`);

  if (mapped.length === 0) {
    console.warn(`[images:manifest] WARNING: no images found in ${source.absoluteDir}`);
  }

  return mapped;
}

function formatArray(name, values) {
  if (values.length === 0) {
    return `export const ${name}: string[] = [];\n`;
  }

  const rows = values.map((value) => `  "${value}"`).join(",\n");
  return `export const ${name}: string[] = [\n${rows}\n];\n`;
}

async function run() {
  const [stockImages, beforeAfterImages] = await Promise.all(sources.map(buildSourceManifest));

  const output = `/* eslint-disable */
/* This file is auto-generated by scripts/generate-image-manifest.mjs. */

${formatArray("STOCK_IMAGES", stockImages)}
${formatArray("BEFORE_AFTER_IMAGES", beforeAfterImages)}
`;

  const targetFile = path.join(projectRoot, "src", "lib", "image-manifest.ts");
  await fs.mkdir(path.dirname(targetFile), {recursive: true});
  await fs.writeFile(targetFile, output, "utf8");

  console.log(`[images:manifest] stock images: ${stockImages.length}`);
  console.log(`[images:manifest] before-after images: ${beforeAfterImages.length}`);
  console.log(
    `[images:manifest] stock sample: ${
      stockImages.length > 0 ? stockImages.slice(0, 3).join(", ") : "(none)"
    }`
  );
  console.log(
    `[images:manifest] before-after sample: ${
      beforeAfterImages.length > 0 ? beforeAfterImages.slice(0, 3).join(", ") : "(none)"
    }`
  );
}

run().catch((error) => {
  console.error("[images:manifest] ERROR:", error);
  process.exitCode = 1;
});
